<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ãƒªãƒãƒ¼ã‚¹1999 æ‰€æŒã‚­ãƒ£ãƒ©ï¼†å¿ƒç›¸ä¸€è¦§</title>
    <style>
      body {
        font-family: "Segoe UI", "Hiragino Sans", sans-serif;
        background: #1a1a1a;
        margin: 0;
        padding: 20px;
        color: #eee;
      }

      h1 {
        text-align: center;
        margin-bottom: 30px;
        color: #fbc531;
      }
      h2 {
        color: #ddd;
        border-left: 4px solid #fbc531;
        padding-left: 8px;
        margin-bottom: 16px;
      }
      .section {
        margin-bottom: 50px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        grid-auto-rows: 1fr; /* â† ã“ã‚Œã§é«˜ã•ã‚’æƒãˆã‚‹ */
        gap: 24px;
        max-width: 85vw; /* â† ç”»é¢å¹…ã®75%ã«åˆ¶é™ */
        margin: 0 auto; /* â† ä¸­å¤®å¯„ã› */
      }
      .card {
        position: relative;
        background: #2a2a2a;
        border-radius: 10px;
        text-align: center;
        padding: 10px;
        transition: all 0.25s ease;
        cursor: pointer;
        color: #f0f0f0;
        opacity: 0.4;
        filter: grayscale(60%);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* ä¸Šä¸‹ã«åˆ†æ•£é…ç½® */
        height: 100%; /* é«˜ã•ã‚’å›ºå®šã™ã‚‹å ´åˆã¯æŒ‡å®š */
      }
      .card img {
        width: 100%;
        aspect-ratio: 1 / 1; /* æ­£æ–¹å½¢ã‚’ç¶­æŒ */
        object-fit: cover; /* ã¯ã¿å‡ºã—ã‚’ãƒˆãƒªãƒŸãƒ³ã‚° */
        border-radius: 8px;
      }
      /*.card h3 {
  margin: 8px 0 4px;
  font-size: 16px; */
      .card h3 {
        margin: 8px 0 4px;
        font-size: clamp(12px, 4vw, 16px); /* â† ç”»é¢å¹…ã«å¿œã˜ã¦ç¸®å° */
        white-space: normal; /* æ”¹è¡Œ nowrap */
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .card p {
        font-size: 14px;
        color: #ccc;
        margin: 0;
      }
      .card.owned {
        opacity: 1;
        filter: none;
        border: 1px solid #f99931;
        box-shadow: 0 0 14px rgba(251, 197, 49, 0.6);
        background: linear-gradient(145deg, #2d250f, #3b320f);
      }

      .madness-group {
        text-align: center;
        margin-bottom: 4px;
      }

      .card-footer {
        margin-top: auto; /* â† ã“ã‚Œã§ç‹‚æƒ³ï¼‹æ˜Ÿã‚’ä¸‹ã«æŠ¼ã—è¾¼ã‚€ */
        text-align: center;
      }

      .card .stars {
        margin-top: 0; /* ä¸€ç•ªä¸‹ã«æŠ¼ã—å‡ºã™ */
      }

      .madness-label {
        display: inline-block;
        margin: 0 2px;
        font-size: 13px;
        font-weight: bold;
        color: #555;
      }

      .madness-highlight {
        color: #ffde73; /* å¥½ããªå¼·èª¿è‰²ã«å¤‰æ›´å¯èƒ½ */
      }

      .distortion-group {
        text-align: center;
        margin: 4px 0 -19px;
      }

      .distortion-label {
        display: inline-block;
        margin: 0 2px;
        font-size: 13px;
        font-weight: normal;
        color: #ccc; /* å·®åˆ¥åŒ– */
      }

      .edit-button {
        position: absolute;
        top: 6px;
        right: 6px;
        background: #555;
        border: none;
        border-radius: 5px;
        font-size: 12px;
        padding: 3px 6px;
        cursor: pointer;
        color: #fff;
        transition: background 0.2s;
      }
      .edit-button:hover {
        background: #fbc531;
        color: #111;
      }

      .edit-button:active {
        transform: scale(0.98);
      }

      .modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: #2a2a2a;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
        padding: 20px;
        z-index: 1000;
        display: none;
        width: 280px;
        color: #eee;
      }
      .modal.active {
        display: block;
      }
      .modal h2 {
        margin-top: 0;
        color: #fbc531;
      }
      .modal label {
        display: block;
        margin: 8px 0 4px;
      }
      .modal input {
        width: 100%;
        padding: 4px;
        background: #1a1a1a;
        color: #eee;
        border: 1px solid #444;
        border-radius: 4px;
      }
      .star {
        color: #555;
        font-size: 16px;
      }
      .star.filled {
        color: #f77031;
      }
      .modal-buttons {
        text-align: right;
        margin-top: 24px;
      }
      .modal-buttons button {
        margin-left: 8px;
        padding: 5px 10px;
        background: #444;
        color: #eee;
        border: none;
        border-radius: 5px;
      }
      .modal-buttons button:hover {
        background: #fbc531;
        color: #111;
      }

      #cancelEdit:active,
      #saveEdit:active {
        transform: scale(0.98);
      }

      .level-buttons {
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: nowrap;
        margin-bottom: 8px;
        justify-content: center;
      }

      .level-buttons input[type="number"] {
        width: 60px; /* â† ãŠå¥½ã¿ã§èª¿æ•´ã€‚50ã€œ70pxãŒä½¿ã„ã‚„ã™ã„ */
        text-align: center;
        padding: 4px 6px;
        font-size: 14px;
      }

      /*  .level-buttons:active {
        transform: scale(0.98); /* âœ… æŠ¼ã—è¾¼ã¾ã‚Œã‚‹æ„Ÿè§¦ */

      .soft-btn {
        padding: 5px 10px;
        background: #444;
        color: #eee;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.07s;
      }
      .soft-btn:hover {
        background: #fbc531;
        color: #111;
      }

      .soft-btn:active {
        transform: scale(0.98);
      }

      .radio-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 12px;
        justify-content: center;
      }

      .soft-radio {
        width: 36px;
        height: 36px;
        background: #444;
        color: #eee;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
        position: relative;
      }
      .soft-radio:hover {
        background: #fbc531;
        color: #111;
      }
      .soft-radio input[type="radio"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
      }

      .soft-radio.selected {
        background: #212121 !important;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);
        color: #fbc531 !important;
      }

      .soft-radio input[type="radio"]:checked + span {
        color: #fbc531;
      }

      .soft-radio span {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative; /* èƒŒæ™¯ã¨ã®é‡ãªã‚Šåˆ¶å¾¡ */
      }

      .slider-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
      }

      input[type="range"] {
        flex: 1;
        accent-color: #fbae31; /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã¤ã¾ã¿è‰² */
      }

      .madness-row {
        display: flex;
        gap: 16px;
        margin-top: 8px;
        justify-content: center;
      }

      .madness-item {
        text-align: center;
        font-size: 13px;
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 999;
        display: none;
      }
      .overlay.active {
        display: block;
      }
      .share-btn {
        display: block;
        margin: 0 auto 20px;
        background: #fbc531;
        color: #111;
        font-weight: bold;
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
      }
      .share-btn:hover {
        background: #ffdc75;
      }

      .share-btn:active {
        transform: scale(0.98);
      }

      .share-link {
        text-align: center;
        color: #fbc531;
        margin-top: 10px;
        word-break: break-all;
      }
      #copyNotice {
        text-align: center;
        color: #7bed9f;
        font-weight: bold;
        margin-top: 8px;
        opacity: 0;
        transition: opacity 0.4s ease;
      }
      #copyNotice.visible {
        opacity: 1;
      }

      .distortion-panel {
        position: fixed;
        top: 50%;
        left: calc(50% + 160px); /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å³å´ã«é…ç½®ï¼ˆèª¿æ•´å¯ï¼‰ */
        transform: translateY(-50%);
        background: #2a2a2a;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
        padding: 20px;
        z-index: 1001;
        width: 200px;
        display: none;
        color: #eee;
      }

      .distortion-panel.active {
        display: block;
      }

      .distortion-toggle-btn {
        margin-top: 12px;
        background: #555;
        color: #fff;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
      }
      .distortion-toggle-btn:hover {
        background: #fbc531;
        color: #111;
      }
      .distortion-toggle-btn:active {
        transform: scale(0.98); /* âœ… æŠ¼ã—è¾¼ã¾ã‚Œã‚‹æ„Ÿè§¦ */
      }

      @media screen and (max-width: 600px) {
        .distortion-panel {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 90vw;
          max-height: 70vh;
          overflow-y: auto;
          padding: 16px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.7);
          z-index: 1001;
        }
      }

      .mindset-spacer {
          height: clamp(18px, 1.3125em, 21px);
}

      #toggleMindsetPanel {
        margin-top: 12px;
        background: #555;
        color: #fff;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.2s ease;
      }

      #toggleMindsetPanel:hover {
        background-color: #fbc531;
        /*  transform: scale(1.02); /* âœ… ãµã‚ã£ã¨æµ®ãæ„Ÿè§¦  */
      }

      #toggleMindsetPanel:active {
        background-color: #ccc;
        transform: scale(0.98); /* âœ… æŠ¼ã—è¾¼ã¾ã‚Œã‚‹æ„Ÿè§¦ */
      }

      .mindset-list {
        display: grid;
        grid-template-columns: repeat(
          2,
          1fr
        ); /* grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); */
        gap: 12px;
        margin-top: 8px;
        max-height: 200px;
        overflow-y: auto;
        padding: 4px;
      }

      @media (orientation: landscape) and (max-height: 500px) {
        .mindset-list {
          max-height: 180px;
        }
      }

      .mindset-card {
        border: 1px solid #858585;
        border-radius: 8px;
        padding: 6px;
        background-color: #444444;
        cursor: pointer;
        text-align: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .mindset-card img {
        width: 100%;
        height: auto;
        max-height: 80px; /* âœ… é«˜ã•åˆ¶é™ã§ã‚«ãƒ¼ãƒ‰ã«åã‚ã‚‹ */
        object-fit: contain;
        margin-bottom: 4px;
      }

      .mindset-card span {
        font-size: 13px;
        word-break: break-word;
      }

      .mindset-card.selected {
        border-color: #ff8800;
        background-color: #1a1a1a;
        transform: scale(1.03);
        transition: transform 0.04s ease-out;
      }

      .selected-mindset {
        display: block; /* â† inline-block â†’ block ã«å¤‰æ›´ */
        width: 52px;
        height: 52px;
        margin-top: auto; /* â† flexã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦ä¸‹ã«æŠ¼ã—å‡ºã™ */
        padding: 0;
        margin: 4px auto; /* â† autoã§ä¸­å¤®æƒãˆï¼ */
        background-color: transparent;
        line-height: 0;
        box-sizing: border-box;
      }

      .selected-mindset img {
        display: block;
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 2px;
        outline-offset: -5px;
        outline: 3px double #000000;
      }

      .shared-notice {
        position: sticky;
        top: 0;
        background: rgba(0, 0, 0, 0.6); /* åŠé€æ˜ã®é»’èƒŒæ™¯ */
        color: #fff; /* ç™½æ–‡å­— */
        font-weight: bold;
        text-align: center;
        padding: 10px;
        z-index: 1002;
        display: none;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
  </head>
  <body>
    <div id="sharedNotice" class="shared-notice">
      ğŸ”’ å…±æœ‰ãƒ¢ãƒ¼ãƒ‰ã§é–‹ã„ã¦ã„ã¾ã™ï¼ˆç·¨é›†å†…å®¹ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼‰
    </div>

    <h1>ãƒªãƒãƒ¼ã‚¹1999 æ‰€æŒã‚­ãƒ£ãƒ©ãƒ»å¿ƒç›¸ç®¡ç†</h1>

    <button class="share-btn" id="generateLink">
      ğŸ”— çŠ¶æ…‹ã‚’å…±æœ‰URLã¨ã—ã¦ç™ºè¡Œ
    </button>
    <div class="share-link" id="shareLink"></div>
    <div id="copyNotice">âœ… å…±æœ‰URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>

    <button class="share-btn" id="toggleFilter">ğŸ‘ï¸ æ‰€æŒæ¸ˆã¿ã®ã¿è¡¨ç¤º</button>

    <div class="section">
      <h2>ã‚­ãƒ£ãƒ©ä¸€è¦§</h2>
      <div class="grid" id="characterGrid"></div>
    </div>

    <div class="section">
      <h2>å¿ƒç›¸ä¸€è¦§</h2>
      <div class="grid" id="mindsetGrid"></div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="modal" id="editModal">
      <h2 id="editTitle"></h2>
      <div id="editFields"></div>
      <div class="modal-buttons">
        <button id="cancelEdit">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="saveEdit">ä¿å­˜</button>
      </div>
    </div>

    <div id="distortionPanel" class="distortion-panel">
      <h3>å¤‰èª¿ä¸€è¦§</h3>
      <div id="distortionList"></div>
      <div style="text-align: center; margin-top: 16px">
        <button id="closeDistortion" class="distortion-toggle-btn">ä¿å­˜</button>
      </div>
    </div>

    <script src="data.js"></script>

    <script>
      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ¶ˆå»
      // localStorage.removeItem("ownedData");

      let showOnlyOwned = false;
      let currentItem = null;
      let selectedMindset = null;

      // let highlightedMadness = []; // â† ç‹‚æƒ³ã®ç¨®é¡ã”ã¨ã®ONçŠ¶æ…‹ã‚’ä¿æŒ

      function renderStars(count) {
        let html = "";
        for (let i = 0; i < 5; i++)
          html += `<span class="star ${i < count ? "filled" : ""}">â˜…</span>`;
        return html;
      }
      function renderCards(data, containerId, isCharacter = true) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";
        data.forEach((item) => {
          if (showOnlyOwned && !item.owned) return; // â† ã“ã“ãŒè¿½åŠ ãƒã‚¤ãƒ³ãƒˆ
          if (!item.highlightedMadness) item.highlightedMadness = [];
          if (!item.selectedDistortion) item.selectedDistortion = [];

          const card = document.createElement("div");
          card.className = "card";
          if (item.owned) card.classList.add("owned");
          card.innerHTML = `
  <button class="edit-button">âœ</button>
  <img src="${item.img}" alt="${
            item.name
          }" onerror="this.src='images/placeholder.png'">
  <h3>${item.name}</h3>
  <p>
    Lv.${item.level} ${
            isCharacter ? `æ´å¯Ÿ${item.insight}<br>å…±é³´${item.resonance}` : ""
          }
  </p>
  ${
    isCharacter && item.selectedDistortion?.length
      ? `<div class="distortion-group">
      ${
        item.selectedDistortion.includes("â– å…¨éƒ¨ â–")
          ? `<span class="distortion-label">â– å…¨éƒ¨ â–</span>`
          : item.selectedDistortion
              .map(
                (type) => `
              <span class="distortion-label">${type}</span>
            `
              )
              .join("")
      }
    </div>`
      : ""
  }
      
  <div class="card-footer">
${
  item.selectedMindset
    ? (() => {
        const mindset = mindsets.find((ms) => ms.name === item.selectedMindset);
        return mindset
          ? `<div class="selected-mindset"><img src="${mindset.img}" alt="${mindset.name}"></div>`
          : "";
      })()
    : ""
}
${!item.madness?.length ? `<div class="mindset-spacer"></div>` : ""}

    ${
      item.madness?.length
        ? item.madness
            .map(
              (type) => `
          <span class="madness-label ${
            item.highlightedMadness?.includes(type) ? "madness-highlight" : ""
          }">${type}</span>
        `
            )
            .join("")
        : ""
    }
    <div class="stars">
      ${isCharacter ? renderStars(item.statue) : renderStars(item.amplify)}
    </div>
  </div>
`;
          /* ãƒ¬ãƒ™ãƒ«æ´å¯Ÿå…±é³´ç‹‚æƒ³æ˜Ÿcard.innerHTML = `
      Lv.${item.level} ${isCharacter ? `æ´å¯Ÿ${item.insight}<br>å…±é³´${item.resonance}<br>${renderStars(item.statue)}` : `å¢—å¹…<br>${renderStars(item.amplify)}`} */
          // æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆå¡‘åƒã‚ã‚Šï¼‰
          // const oldText = `Lv.${item.level} ${isCharacter ? `æ´å¯Ÿ${item.insight} å…±é³´${item.resonance}<br>å¡‘åƒï¼š${renderStars(item.statue)}` : `å¢—å¹…ï¼š${renderStars(item.amplify)}`}

          card.addEventListener("click", (e) => {
            if (e.target.classList.contains("edit-button")) return;
            item.owned = !item.owned;
            saveState();
            renderAll(); // â† çŠ¶æ…‹å¤‰æ›´å¾Œã«å†æç”»
          });
          card.querySelector(".edit-button").addEventListener("click", (e) => {
            e.stopPropagation();
            openEditModal(item, isCharacter);
          });
          container.appendChild(card);
        });
      }

      function setupMindsetSelection() {
        const cards = document.querySelectorAll(".mindset-card");
        cards.forEach((card) => {
          card.addEventListener("click", () => {
            cards.forEach((c) => c.classList.remove("selected"));
            card.classList.add("selected");
          });
        });
      }

      function getSelectedMindset() {
        const selectedCard = document.querySelector(".mindset-card.selected");
        return selectedCard?.dataset.name || null;
      }

      function openEditModal(item, isCharacter) {
        currentItem = item;
        selectedMindset = item.selectedMindset;
        const modal = document.getElementById("editModal");
        const overlay = document.getElementById("overlay");
        const fields = document.getElementById("editFields");
        document.getElementById(
          "editTitle"
        ).textContent = `${item.name} ã®ç·¨é›†`;
        fields.innerHTML = `
    <label>ãƒ¬ãƒ™ãƒ«</label>
<div class="level-buttons">
  <button class="soft-btn" data-delta="-10">-10</button>
  <button class="soft-btn" data-delta="-1">-1</button>
  <input type="number" id="editLevel" value="${item.level}" min="1" max="60">
  <button class="soft-btn" data-delta="1">+1</button>
  <button class="soft-btn" data-delta="10">+10</button>
</div>
    ${
      isCharacter
        ? `
<label>æ´å¯Ÿ</label>
<div class="radio-group" id="insightGroup">
  ${[0, 1, 2, 3]
    .map((val) =>
      `
    <label class="soft-radio">
      <input type="radio" name="insight" value="${val}" ${
        item.insight === val ? "checked" : ""
      }>
      <span>${val}</span>
    </label>
  `.trim()
    )
    .join("")}
</div>
      <label>å…±é³´</label>
<div class="slider-group">
  <input type="range" id="editResonance" min="1" max="15" step="1" value="${
    item.resonance
  }">
  <span id="resonanceValue">${item.resonance}</span>
</div>
  <button id="toggleDistortionPanel" class="distortion-toggle-btn">å¤‰èª¿ã‚’è¡¨ç¤º</button>
  <button id="toggleMindsetPanel" class="mindset-toggle-btn">å¿ƒç›¸ã‚’é¸æŠ</button>
<div id="mindsetList" style="display: none;" class="mindset-list"></div>
      <label>å¡‘åƒ</label>
<div class="radio-group" id="statueGroup">
  ${[0, 1, 2, 3, 4, 5]
    .map(
      (val) => `
    <label class="soft-radio">
      <input type="radio" name="statue" value="${val}" ${
        item.statue === val ? "checked" : ""
      }>
      <span>${val}</span>
    </label>
  `
    )
    .join("")}
</div>
    `
        : `
      <label>å¢—å¹…</label>
<div class="radio-group" id="amplifyGroup">
  ${[0, 1, 2, 3, 4, 5]
    .map(
      (val) => `
    <label class="soft-radio">
      <input type="radio" name="amplify" value="${val}" ${
        item.amplify === val ? "checked" : ""
      }>
      <span>${val}</span>
    </label>
  `
    )
    .join("")}
</div>
    `
    }
${
  item.madness?.length
    ? `<label>ç‹‚æƒ³</label>
     <div id="madnessToggleGroup" class="madness-row">
       ${item.madness
         .map(
           (type) => `
         <div class="madness-item">
           <input type="checkbox" value="${type}" ${
             item.highlightedMadness?.includes(type) ? "checked" : ""
           }><br>
           <span>${type}</span>
         </div>
       `
         )
         .join("")}
     </div>`
    : ""
}
`;
        modal.classList.add("active");
        overlay.classList.add("active");

        document.querySelectorAll(".level-buttons button").forEach((btn) => {
          btn.addEventListener("click", () => {
            const input = document.getElementById("editLevel");
            const delta = Number(btn.dataset.delta);
            let newVal = Math.min(60, Math.max(1, Number(input.value) + delta));
            input.value = newVal;
          });
        });

        if (isCharacter) {
          const resonanceSlider = document.getElementById("editResonance");
          const resonanceDisplay = document.getElementById("resonanceValue");
          if (resonanceSlider && resonanceDisplay) {
            resonanceSlider.addEventListener("input", () => {
              resonanceDisplay.textContent = resonanceSlider.value;
            });
          }
        }

        if (isCharacter) {
          let selectedMindset = item.selectedMindset;
          const mindsetList = document.getElementById("mindsetList");

          // æç”»å‡¦ç†
          mindsetList.innerHTML = mindsets
            .filter((ms) => ms.owned)
            .map(
              (ms) => `
      <div class="mindset-card ${
        selectedMindset === ms.name ? "selected" : ""
      }" data-name="${ms.name}">
        <img src="${ms.img}" alt="${ms.name}">
        <span>${ms.name}</span>
      </div>
    `
            )
            .join("");

          mindsetList.querySelectorAll(".mindset-card").forEach((card) => {
            card.addEventListener("click", () => {
              const name = card.dataset.name;
              selectedMindset = selectedMindset === name ? null : name;
              /* updateMindsetSelectionUI(); */

              mindsetList
                .querySelectorAll(".mindset-card")
                .forEach((c) => c.classList.remove("selected"));
              if (selectedMindset) {
                mindsetList
                  .querySelector(`[data-name="${selectedMindset}"]`)
                  ?.classList.add("selected");
              }
            });
          });

          // è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
          document.getElementById("toggleMindsetPanel").onclick = () => {
            mindsetList.style.display =
              mindsetList.style.display === "none" ? "block" : "none";
          };
        }
        const toggleButton = document.getElementById("toggleDistortionPanel");
        if (toggleButton) {
          toggleButton.onclick = () => {
            const panel = document.getElementById("distortionPanel");
            panel.classList.toggle("active");

            const distortionTypes = [
              "é€šæš",
              "èª å®Ÿ",
              "äº¢å¥®",
              "é¼“èˆ",
              "å¸Œæœ›",
              "æ…ˆæ‚²",
              "æº€è¶³",
              "é®é™",
              "ç¯€åˆ¶",
              "ä¸€æ„å°‚å¿ƒ",
              "å¥‡æƒ³å¤©å¤–",
              "ç„¡æˆ‘å¤¢ä¸­",
              "æ³°ç„¶è‡ªè‹¥",
              "å‡è¡¡èª¿å’Œ",
              "â– å…¨éƒ¨ â–",
            ];

            const list = document.getElementById("distortionList");
            list.dataset.owner = item.name;
            list.innerHTML = distortionTypes
              .map(
                (type) => `
  <label>
    <input type="checkbox" value="${type}" ${
                  item.selectedDistortion?.includes(type) ? "checked" : ""
                }>
    ${type}
  </label>
`
              )
              .join("<br>");

            const checkboxes = list.querySelectorAll("input[type=checkbox]");
            checkboxes.forEach((cb) => {
              cb.addEventListener("change", () => {
                if (cb.value === "â– å…¨éƒ¨ â–" && cb.checked) {
                  checkboxes.forEach((other) => {
                    if (other.value !== "â– å…¨éƒ¨ â–") other.checked = false;
                  });
                } else if (cb.value !== "â– å…¨éƒ¨ â–" && cb.checked) {
                  checkboxes.forEach((other) => {
                    if (other.value === "â– å…¨éƒ¨ â–") other.checked = false;
                  });
                }
              });
            });
          };
        }

        fields.querySelectorAll(".radio-group").forEach((group) => {
          const radios = group.querySelectorAll('input[type="radio"]');
          radios.forEach((radio) => {
            if (radio.checked) {
              radio.closest(".soft-radio").classList.add("selected");
            }

            radio.addEventListener("change", () => {
              group
                .querySelectorAll(".soft-radio")
                .forEach((el) => el.classList.remove("selected"));
              if (radio.checked) {
                radio.closest(".soft-radio").classList.add("selected");
              }
            });
          });
        });

        document.getElementById("cancelEdit").onclick = closeModal;
        document.getElementById("saveEdit").onclick = () => {
          item.level = Number(document.getElementById("editLevel").value);

          if (isCharacter) {
            const insightInput = document.querySelector(
              "input[name=insight]:checked"
            );
            if (insightInput) item.insight = Number(insightInput.value);

            item.resonance = Number(
              document.getElementById("editResonance").value
            );

            const statueInput = document.querySelector(
              "input[name=statue]:checked"
            );
            if (statueInput) item.statue = Number(statueInput.value);
          } else {
            const amplifyInput = fields.querySelector(
              "input[name=amplify]:checked"
            );
            if (amplifyInput) item.amplify = Number(amplifyInput.value);
          }

          const madnessChecks = document.querySelectorAll(
            "#madnessToggleGroup input[type=checkbox]"
          );
          item.highlightedMadness = Array.from(madnessChecks)
            .filter((cb) => cb.checked)
            .map((cb) => cb.value);

          const distortionList = document.getElementById("distortionList");
          if (distortionList?.dataset.owner === item.name) {
            const distortionChecks = distortionList.querySelectorAll(
              "input[type=checkbox]"
            );
            item.selectedDistortion = Array.from(distortionChecks)
              .filter((cb) => cb.checked)
              .map((cb) => cb.value);
          }

          currentItem.selectedMindset = getSelectedMindset();
          item.selectedMindset = getSelectedMindset();

          saveState();
          renderAll();
          document.getElementById("distortionPanel").classList.remove("active");
          closeModal();
        };
      }
      function closeModal() {
        document.getElementById("editModal").classList.remove("active");
        document.getElementById("overlay").classList.remove("active");
        document.getElementById("distortionPanel").classList.remove("active");
        const list = document.getElementById("distortionList");
        if (list) {
          list.innerHTML = "";
          delete list.dataset.owner;
        }
      }
      function saveState() {
        if (isSharedView) return; // å…±æœ‰URLã‹ã‚‰é–‹ã„ãŸå ´åˆã¯ä¿å­˜ã—ãªã„
        localStorage.setItem(
          "ownedData",
          JSON.stringify({ characters, mindsets })
        );
      }
      function loadState() {
        const saved = JSON.parse(localStorage.getItem("ownedData") || "{}");
        if (saved.characters) mergeState(saved.characters, characters);
        if (saved.mindsets) mergeState(saved.mindsets, mindsets);
      }
      function mergeState(savedArray, baseArray) {
        savedArray.forEach((savedItem) => {
          const match = baseArray.find((i) => i.name === savedItem.name);
          if (match) Object.assign(match, savedItem);
        });
      }
      function encodeState() {
        return encodeURIComponent(
          btoa(JSON.stringify({ characters, mindsets }))
        );
      }
      function decodeState(str) {
        try {
          const data = JSON.parse(atob(decodeURIComponent(str)));
          if (data.characters) mergeState(data.characters, characters);
          if (data.mindsets) mergeState(data.mindsets, mindsets);
        } catch {}
      }
      function renderAll() {
        renderCards(characters, "characterGrid", true);
        renderCards(mindsets, "mindsetGrid", false);
      }
      function getSelectedData() {
        const ownedCharacters = characters
          .filter((c) => c.owned)
          .map((c) => ({
            name: c.name,
            level: c.level,
            insight: c.insight,
            resonance: c.resonance,
            statue: c.statue,
            madness: c.madness,
            highlightedMadness: c.highlightedMadness || [],
            selectedDistortion: c.selectedDistortion || [],
            selectedMindset: c.selectedMindset || null,
            img: c.img,
            owned: true,
          }));

        const ownedMindsets = mindsets
          .filter((m) => m.owned)
          .map((m) => ({
            name: m.name,
            level: m.level,
            amplify: m.amplify,
            madness: m.madness,
            highlightedMadness: m.highlightedMadness || [],
            img: m.img,
            owned: true,
          }));

        return { characters: ownedCharacters, mindsets: ownedMindsets };
      }
      function encodeData(data) {
        const json = JSON.stringify(data);
        return LZString.compressToEncodedURIComponent(json);
      }

      async function generateShortUrl(data) {
        const longUrl = `${location.origin}${
          location.pathname
        }?data=${encodeData(data)}`;
        const tinyApi = `https://tinyurl.com/api-create.php?url=${encodeURIComponent(
          longUrl
        )}`;
        const shortUrl = await fetch(tinyApi).then((res) => res.text());
        return shortUrl;
      }

      function decodeData(str) {
        try {
          const json = LZString.decompressFromEncodedURIComponent(str);
          return JSON.parse(json);
        } catch (e) {
          console.warn("ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", e);
          return null;
        }
      }

      let isSharedView = false;

      document.addEventListener("DOMContentLoaded", () => {
        const hasSharedData = location.search.startsWith("?data=");
        let sharedData = null;

        if (hasSharedData) {
          sharedData = decodeData(location.search.substring(6));
          isSharedView = true;
        }

        if (
          sharedData &&
          sharedData.characters &&
          sharedData.characters.length > 0
        ) {
          mergeState(sharedData.characters, characters);
          mergeState(sharedData.mindsets, mindsets);
        } else {
          loadState();
        }

        renderAll();

        if (isSharedView) {
          document.getElementById("sharedNotice").style.display = "block";
        }

        document
          .getElementById("closeDistortion")
          ?.addEventListener("click", () => {
            document
              .getElementById("distortionPanel")
              .classList.remove("active");
          });
        document
          .querySelectorAll('.soft-radio input[type="radio"]')
          .forEach((radio) => {
            radio.addEventListener("change", () => {
              document
                .querySelectorAll(".soft-radio")
                .forEach((el) => el.classList.remove("selected"));
              if (radio.checked) {
                radio.closest(".soft-radio").classList.add("selected");
              }
            });

            if (radio.checked) {
              radio.closest(".soft-radio").classList.add("selected");
            }
          });
      });

      // å…±æœ‰ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
      document
        .getElementById("generateLink")
        .addEventListener("click", async () => {
          const selectedData = getSelectedData();
          const shortUrl = await generateShortUrl(selectedData); // â† çŸ­ç¸®URLã‚’å–å¾—

          const link = document.getElementById("shareLink");
          link.innerHTML = `<a href="${shortUrl}" target="_blank">${shortUrl}</a>`;

          try {
            await navigator.clipboard.writeText(shortUrl);
            const notice = document.getElementById("copyNotice");
            notice.classList.add("visible");
            setTimeout(() => notice.classList.remove("visible"), 2500);
          } catch (e) {
            console.warn("ã‚³ãƒ”ãƒ¼å¤±æ•—:", e);
          }
        });

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
      document.getElementById("toggleFilter").addEventListener("click", () => {
        showOnlyOwned = !showOnlyOwned;
        document.getElementById("toggleFilter").textContent = showOnlyOwned
          ? "ğŸ‘ï¸ å…¨è¡¨ç¤ºã«æˆ»ã™"
          : "ğŸ‘ï¸ æ‰€æŒæ¸ˆã¿ã®ã¿è¡¨ç¤º";
        renderAll();
      });
    </script>
  </body>
</html>
